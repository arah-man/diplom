{% extends 'base.html' %}

{% block content %}
<div class="cart-container">
    <h1>Ваша корзина</h1>
    
    {% if items %}
    <div class="cart-items">
        <table>
            <thead>
                <tr>
                    <th>Товар</th>
                    <th>Цвет</th>
                    <th>Размер</th>
                    <th>Цена</th>
                    <th>Количество</th>
                    <th>Сумма</th>
                    <th>Действия</th>
                </tr>
            </thead>
            <tbody>
                {% for item in items %}
                <tr>
                    <td>
                        <a href="{{ item.product.get_absolute_url }}">
                            {{ item.product.name }}
                        </a>
                    </td>
                    <td>
                        {% if item.color %}
                        <span style="background: {{ item.color.hex_code }}; 
                                    display: inline-block; 
                                    width: 15px; 
                                    height: 15px; 
                                    border-radius: 50%; 
                                    border: 1px solid #ddd;"></span>
                        {{ item.color.name }}
                        {% else %}
                        -
                        {% endif %}
                    </td>
                    <td>{{ item.size.name|default:"-" }}</td>
                    <td>{{ item.product.price }} руб.</td>
                    <td>
                        <form class="update-form" method="post" action="{% url 'update_cart_item' item.id %}">
                            {% csrf_token %}
                            <input type="number" name="quantity" value="{{ item.quantity }}" min="1" class="quantity-input">
                        </form>
                    </td>
                    <td>{{ item.total_price }} руб.</td>
                    <td>
                        <a href="{% url 'remove_from_cart' item.id %}" class="remove-btn">Удалить</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        
        <div class="cart-summary">
            <h3>Итого: {{ cart.total_price }} руб.</h3>
            <a href="{% url 'create_order' %}" class="checkout-btn">Оформить заказ</a>
        </div>
    </div>
    {% else %}
    <p>Ваша корзина пуста.</p>
    {% endif %}
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
    // Обновление количества при изменении
    document.querySelectorAll('.quantity-input').forEach(input => {
        input.addEventListener('change', function() {
            this.closest('form').submit();
        });
    });
    
    // AJAX для форм
    document.querySelectorAll('.add-to-cart-form, .update-form').forEach(form => {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            fetch(this.action, {
                method: 'POST',
                body: new FormData(this),
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Обновляем иконку корзины с количеством товаров
                    const cartIcon = document.querySelector('.cart-icon');
                    if (cartIcon) {
                        cartIcon.textContent = data.cart_total;
                    }
                    
                    // Если это форма обновления, обновляем суммы
                    if (this.classList.contains('update-form')) {
                        const row = this.closest('tr');
                        if (row) {
                            const itemTotalCell = row.querySelector('td:nth-child(6)');
                            if (itemTotalCell) {
                                itemTotalCell.textContent = data.item_total + ' руб.';
                            }
                            
                            const cartTotal = document.querySelector('.cart-summary h3');
                            if (cartTotal) {
                                cartTotal.textContent = 'Итого: ' + data.cart_total_price + ' руб.';
                            }
                        }
                    } else {
                        // Для формы добавления можно показать уведомление
                        alert('Товар добавлен в корзину!');
                    }
                }
            })
            .catch(error => {
                console.error('Error:', error);
                this.submit(); // Отправляем форму обычным способом при ошибке
            });
        });
    });
});
</script>
{% endblock %}