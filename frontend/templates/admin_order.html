{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="profile-container">
  <h1 class="profile-title">üì¶ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞–º–∏</h1>

  <!-- –§–æ—Ä–º–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ -->
  <form method="get" class="row g-3 align-items-end mb-4">
    <div class="col-md-3">
      <label for="status" class="form-label">–§–∏–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å—É:</label>
      <select name="status" id="status" class="form-select">
        <option value="">–í—Å–µ</option>
        <option value="0">–ù–æ–≤–∞—è</option>
        <option value="1">–í –û–±—Ä–∞–±–æ—Ç–∫–µ</option>
        <option value="2">–ü—Ä–∏–Ω—è—Ç–∞</option>
        <option value="3">–ó–∞–≤–µ—Ä—à–µ–Ω–∞</option>
        <option value="4">–û—Ç–º–µ–Ω–µ–Ω–∞</option>
      </select>
    </div>
    <div class="col-md-auto">
      <button type="submit" class="btn btn-outline-dark">–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä</button>
    </div>
  </form>

  <!-- –°–ø–∏—Å–æ–∫ –∑–∞–∫–∞–∑–æ–≤ -->
  {% for order in orders %}
    <div class="order-block mb-4 border p-3 rounded shadow-sm">
      <div id="summary-block-{{ order.id }}">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <p><strong>–ó–∞–∫–∞–∑ ‚Ññ{{ order.id }}</strong> –æ—Ç {{ order.date_at|date:"d.m.Y" }}</p>
            <p><strong>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</strong> {{ order.user.username }}</p>
            <p><strong>–°—Ç–∞—Ç—É—Å:</strong> {{ order.get_status_display }}</p>
          </div>
          <div>
            <button class="btn btn-sm btn-outline-dark" onclick="toggleDetails({{ order.id }})">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</button>
          </div>
        </div>
      </div>

      <div id="details-block-{{ order.id }}" style="display: none;">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div>
            <p><strong>–§–ò–û:</strong>{{ user.last_name}} {{ user.first_name}} {{ user.third_name}}</p>
            <p><strong>–ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:</strong> {{ user.phone|default:"‚Äî" }}</p>            
            <p><strong>–û–ø–ª–∞—Ç–∞:</strong> {{ order.get_type_payment_display }}</p>
            <p><strong>–ü—É–Ω–∫—Ç –≤—ã–¥–∞—á–∏:</strong> {{ order.address|default:"‚Äî" }}</p>
          </div>
          <div class="d-flex gap-2">
            <button class="btn btn-sm btn-outline-secondary" onclick="toggleDetails({{ order.id }})">–°–∫—Ä—ã—Ç—å</button>
            <button class="btn btn-sm btn-outline-dark" data-bs-toggle="modal" data-bs-target="#editModal-{{ order.id }}">
              –ò–∑–º–µ–Ω–∏—Ç—å
            </button>
          </div>
        </div>

        <table class="table">
          <thead>
            <tr>
              <th>–¢–æ–≤–∞—Ä</th>
              <th>–¶–≤–µ—Ç</th>
              <th>–†–∞–∑–º–µ—Ä</th>
              <th>–ö–æ–ª-–≤–æ</th>
              <th>–¶–µ–Ω–∞</th>
              <th>–ò—Ç–æ–≥–æ</th>
            </tr>
          </thead>
          <tbody>
            {% for item in order.items.all %}
              <tr>
                <td>{{ item.product.name }}</td>
                <td>
                  {% if item.color %}
                    <span class="color-circle" style="background-color: {{ item.color.hex_code }}"></span>
                    {{ item.color.name }}
                  {% else %}‚Äî{% endif %}
                </td>
                <td>{% if item.size %}{{ item.size.name }}{% else %}‚Äî{% endif %}</td>
                <td>{{ item.quantity }}</td>
                <td>{{ item.price }} ‚ÇΩ</td>
                <td>{{ item.total_price }} ‚ÇΩ</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
        <p class="order-total">–û–±—â–∞—è —Å—É–º–º–∞: <strong>{{ order.total_price }} ‚ÇΩ</strong></p>
      </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ -->
    <div class="modal fade" id="editModal-{{ order.id }}" tabindex="-1" aria-labelledby="editModalLabel-{{ order.id }}" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <form method="post" action="{% url 'update_order_status' order.id %}">
            {% csrf_token %}
            <div class="modal-header">
              <h5 class="modal-title" id="editModalLabel-{{ order.id }}">–ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–∫–∞–∑–∞</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
            </div>
            <div class="modal-body">
              <label for="status-select-{{ order.id }}" class="form-label">–°—Ç–∞—Ç—É—Å:</label>
              <select name="status" id="status-select-{{ order.id }}" class="form-select">
                {% for value, label in order.STATUS_CHOICES %}
                  <option value="{{ value }}" {% if value == order.status %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
              <button type="submit" class="btn btn-dark">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  {% endfor %}

  {% if orders|length == 0 %}
    <p class="text-muted">–ù–µ—Ç –∑–∞–∫–∞–∑–æ–≤</p>
  {% endif %}
</div>

<style>
  .color-circle {
    display: inline-block;
    width: 15px;
    height: 15px;
    border-radius: 50%;
    border: 1px solid #ccc;
    margin-right: 5px;
    vertical-align: middle;
  }
  .order-total {
    text-align: right;
    font-weight: bold;
  }
</style>

<script>
  function toggleDetails(id) {
    const summary = document.getElementById(`summary-block-${id}`);
    const details = document.getElementById(`details-block-${id}`);
    if (summary.style.display === 'none') {
      summary.style.display = 'block';
      details.style.display = 'none';
    } else {
      summary.style.display = 'none';
      details.style.display = 'block';
    }
  }
</script>
{% endblock %}
