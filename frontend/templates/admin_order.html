{% extends 'base.html' %}
{% load static %}

{% block title %} –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞–º–∏ {% endblock %}

{% block content %}
<div class="profile-container">
  <h1 class="profile-title">üì¶ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞–º–∏</h1>

  <!-- –§–æ—Ä–º–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ —Å—Ç–∞—Ç—É—Å—É -->
  <form method="get" class="row g-3 align-items-end mb-4">
    <div class="col-md-3">
      <label for="status" class="form-label">–§–∏–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å—É:</label>
      <select name="status" id="status" class="form-select">
        <option value="">–í—Å–µ</option>
        <option value="0">–ù–æ–≤–∞—è</option>
        <option value="1">–í –û–±—Ä–∞–±–æ—Ç–∫–µ</option>
        <option value="2">–ü—Ä–∏–Ω—è—Ç–∞</option>
        <option value="3">–ó–∞–≤–µ—Ä—à–µ–Ω–∞</option>
        <option value="4">–û—Ç–º–µ–Ω–µ–Ω–∞</option>
      </select>
    </div>
    <div class="col-md-auto">
      <button type="submit" class="btn">–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä</button>
    </div>
  </form>

  <!-- –°–ø–∏—Å–æ–∫ –∑–∞–∫–∞–∑–æ–≤ -->
  {% for order in orders %}
    <div class="order-block mb-4 border p-3 rounded shadow-sm">
      <!-- –°–≤–æ–¥–∫–∞ –ø–æ –∑–∞–∫–∞–∑—É -->
      <div id="summary-block-{{ order.id }}">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <p><strong>–ó–∞–∫–∞–∑ ‚Ññ{{ order.id }}</strong> –æ—Ç {{ order.date_at|date:"d.m.Y" }}</p>
            <p><strong>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</strong> {{ order.user.username }}</p>
            <p><strong>–°—Ç–∞—Ç—É—Å:</strong> {{ order.get_status_display }}</p>
          </div>
          <div id="toggle-button-show-{{ order.id }}">
            <button class="btn" onclick="toggleDetails({{ order.id }})">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</button>
          </div>
        </div>
      </div>

      <!-- –ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –∑–∞–∫–∞–∑–∞ (—Å–∫—Ä—ã—Ç—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
      <div id="details-block-{{ order.id }}" style="display: none;">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div>
            <p><strong>–§–ò–û:</strong> {{ user.last_name }} {{ user.first_name }} {{ user.third_name }}</p>
            <p><strong>–ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:</strong> {{ user.phone|default:"‚Äî" }}</p>
            <p><strong>–û–ø–ª–∞—Ç–∞:</strong> {{ order.get_type_payment_display }}</p>
            <p><strong>–ü—É–Ω–∫—Ç –≤—ã–¥–∞—á–∏:</strong> {{ order.address|default:"‚Äî" }}</p>
          </div>
          <div id="toggle-buttons-hide-{{ order.id }}" class="d-flex gap-2" style="display: none;">
            <button class="btn" onclick="toggleDetails({{ order.id }})">–°–∫—Ä—ã—Ç—å</button>
            <button class="btn" data-bs-toggle="modal" data-bs-target="#editModal-{{ order.id }}">–ò–∑–º–µ–Ω–∏—Ç—å</button>
          </div>
        </div>

        <!-- –¢–∞–±–ª–∏—Ü–∞ —Ç–æ–≤–∞—Ä–æ–≤ -->
        <table class="table">
          <thead>
            <tr>
              <th>–¢–æ–≤–∞—Ä</th>
              <th>–¶–≤–µ—Ç</th>
              <th>–†–∞–∑–º–µ—Ä</th>
              <th>–ö–æ–ª-–≤–æ</th>
              <th>–¶–µ–Ω–∞</th>
              <th>–ò—Ç–æ–≥–æ</th>
            </tr>
          </thead>
          <tbody>
            {% for item in order.items.all %}
              <tr>
                <td>{{ item.product.name }}</td>
                <td>
                  {% if item.color %}
                    <span class="color-circle" style="background-color: {{ item.color.hex_code }}"></span>
                    {{ item.color.name }}
                  {% else %}‚Äî{% endif %}
                </td>
                <td>{% if item.size %}{{ item.size.name }}{% else %}‚Äî{% endif %}</td>
                <td>{{ item.quantity }}</td>
                <td>{{ item.price }} ‚ÇΩ</td>
                <td>{{ item.total_price }} ‚ÇΩ</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>

        <p class="order-total">–û–±—â–∞—è —Å—É–º–º–∞: <strong>{{ order.total_price }} ‚ÇΩ</strong></p>
      </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ -->
    <div class="modal fade" id="editModal-{{ order.id }}" tabindex="-1" aria-labelledby="editModalLabel-{{ order.id }}" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <form method="post" action="{% url 'update_order_status' order.id %}" onsubmit="return validateCancelReason({{ order.id }});">
            {% csrf_token %}
            <div class="modal-header">
              <h5 class="modal-title" id="editModalLabel-{{ order.id }}">–ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–∫–∞–∑–∞</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
            </div>
            <div class="modal-body">
              <label for="status-select-{{ order.id }}" class="form-label">–°—Ç–∞—Ç—É—Å:</label>
              <select name="status" id="status-select-{{ order.id }}" class="form-select" onchange="handleStatusChange({{ order.id }});">
                {% for value, label in order.STATUS_CHOICES %}
                  <option value="{{ value }}" {% if value == order.status %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
              </select>

              <!-- –ë–ª–æ–∫ –ø—Ä–∏—á–∏–Ω—ã –æ—Ç–º–µ–Ω—ã (–ø–æ—è–≤–ª—è–µ—Ç—Å—è, –µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω —Å—Ç–∞—Ç—É—Å "–û—Ç–º–µ–Ω—ë–Ω") -->
              <div id="cancel-reason-block-{{ order.id }}" class="mt-3" style="display: none;">
                <label for="cancel-reason-text-{{ order.id }}" class="form-label">–ü—Ä–∏—á–∏–Ω–∞ –æ—Ç–º–µ–Ω—ã:</label>
                <textarea name="cancel_reason" id="cancel-reason-text-{{ order.id }}" class="form-control" rows="3" placeholder="–£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –æ—Ç–º–µ–Ω—ã..."></textarea>
                <div class="invalid-feedback">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –æ—Ç–º–µ–Ω—ã.</div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∏—Ç—å</button>
              <button type="submit" class="btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  {% endfor %}

  {% if orders|length == 0 %}
    <p class="text-muted">–ù–µ—Ç –∑–∞–∫–∞–∑–æ–≤</p>
  {% endif %}
</div>
{% endblock %}

{% block scripts %}
{{ block.super }}
<!-- –°–∫—Ä–∏–ø—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞–º–∏ -->
<script>
  // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–µ–π –∑–∞–∫–∞–∑–∞
  function toggleDetails(id) {
    const summary = document.getElementById(`summary-block-${id}`);
    const details = document.getElementById(`details-block-${id}`);
    const showBtn = document.getElementById(`toggle-button-show-${id}`);
    const hideBtns = document.getElementById(`toggle-buttons-hide-${id}`);

    const isOpen = details.style.display === 'block';

    if (isOpen) {
      details.style.display = 'none';
      showBtn.style.display = 'block';
      hideBtns.style.display = 'none';
    } else {
      details.style.display = 'block';
      showBtn.style.display = 'none';
      hideBtns.style.display = 'flex';
    }
  }

  // –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å/—Å–∫—Ä—ã–≤–∞—Ç—å –ø—Ä–∏—á–∏–Ω—É –æ—Ç–º–µ–Ω—ã –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Å—Ç–∞—Ç—É—Å–∞
  function handleStatusChange(orderId) {
    const select = document.getElementById(`status-select-${orderId}`);
    const cancelBlock = document.getElementById(`cancel-reason-block-${orderId}`);
    const cancelReason = document.getElementById(`cancel-reason-text-${orderId}`);

    if (select.value === '4') {
      cancelBlock.style.display = 'block';
    } else {
      cancelBlock.style.display = 'none';
      cancelReason.classList.remove('is-invalid');
      cancelReason.value = '';
    }
  }

  // –í–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–∏—á–∏–Ω—ã –æ—Ç–º–µ–Ω—ã –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ñ–æ—Ä–º—ã
  function validateCancelReason(orderId) {
    const select = document.getElementById(`status-select-${orderId}`);
    const cancelReason = document.getElementById(`cancel-reason-text-${orderId}`);

    if (select.value === '4') {
      if (cancelReason.value.trim() === '') {
        cancelReason.classList.add('is-invalid');
        cancelReason.focus();
        return false;
      } else {
        cancelReason.classList.remove('is-invalid');
      }
    }
    return true;
  }
</script>
{% endblock %}
